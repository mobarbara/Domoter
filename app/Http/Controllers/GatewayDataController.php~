<?php

namespace App\Http\Controllers;
use DB;
use Carbon\Carbon;
use Illuminate\Http\Request;

class GatewayDataController extends Controller
{	

	 public function get_data(){
		  $date = Carbon::now()->toDateTimeString();
		  return $date;
	 }
	
	 public function index(){
	 	  $gateways = DB::select('select * from gateways');
		  return view('gatewayIndex', ['gateways' => $gateways]);
	 }
	 
	 public function info($id){
		  $gateways = DB::select('select * from gateways where id = ?', [$id]);	
		  return view('gatewayInfo', ['gateways' => $gateways]);
	 }	 
	 
	 public function getLastInsertedId() {
		  $no_id = DB::table('gateways')->count();
		  return $no_id; 
	 }
	 
	 public function create(){
		  return view('gatewayCreate');
	 }
	 
	 public function remove($id){
	 	
	 	  $gateway = DB::select('select * from gateways where id = ?', [$id]);
		  return view('gatewayDelete', ['gateway' => $gateway]);	 
	 }	
	 
	 public function edit($id){
		  $gateway = DB::select('select * from gateways where id = ?', [$id]);
		  return view('gatewayEdit', ['gateway' => $gateway]);	 
	 } 
	 
	 public function insert(Request $request){ 
		  	            
		  	 $name = $request['name'];         
		  	 $mqtt_server = $request['mqtt_server'];
		  	 $mqtt_port = $request['mqtt_port'];
		  	 $online = false;
		  	 $last_alive = GatewayDataController::get_data();
		  	 $id = GatewayDataController::getLastInsertedId();
		  	 $id++;
		  	 $data = array('id' => $id, 'name' => $name, 'mqtt_server' => $mqtt_server, 
		  	 'mqtt_port' => $mqtt_port, 'online' => $online, 'last_alive' => $last_alive);
		  	 DB::table('gateways')->insert($data);
			 $view = GatewayDataController::index();
          echo $view; 	 
	 }
	 
    public function update_last_alive($id)
    {
		  $last_alive = GatewayDataController::get_data();
        DB::update('update gateways set last_alive = ? where id = ?', [$last_alive,$id]);           
    	  $view = GatewayDataController::index();
        echo $view; 
    }

	 public function update_online(Request $request, $id){
	 	  $online = $request['online'];
	 	  DB::update('update gateways set online = ? where id = ?', [$online,$id]); 
	 	  $view = GatewayDataController::index();
        echo $view; 
	 }    
	 
	 public function update(Request $request, $id) 
    {
        $name = $request['name'];
		  $mqtt_server = $request['mqtt_server'];
		  $mqtt_port = $request['mqtt_port'];
        DB::update('update gateways set name = ?, mqtt_server = ?, mqtt_port = ? where id = ?', 
        [$name,$mqtt_server,$mqtt_port,$id]);
        $view = GatewayDataController::index();
		  echo $view; 
    }
       
	 public function delete(Request $request, $id){ 
	 	  DB::delete('delete from gateways where id = ?', [$id]);
		  $view = GatewayDataController::index();
        echo $view;  
	 }     
}
